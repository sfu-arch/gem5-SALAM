#include "../spmv_clstr_hw_defines.h"
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <sys/time.h>
#include <stdlib.h>
#include <math.h>
#include <inttypes.h>
#include <string.h>

extern "C" {
    void top();
}

extern int enzyme_const;
template<typename Return, typename... T>
Return __enzyme_autodiff(T...);

#define DIMS N
void compute(taco_tensor_t *y, taco_tensor_t *a, taco_tensor_t *x, taco_tensor_t *z) {
  double* y_vals = (double*)(y->vals);
  int* a2_pos = (int*)(a->indices);
  double* a_vals = (double*)(a->vals);
  double* x_vals = (double*)(x->vals);
  int z1_dimension = (int)(DIMS);
  double* z_vals = (double*)(z->vals);

  int32_t iy = 0;
  for (int32_t i = 0; i < DIMS; i++) {

    for (int32_t ja = a2_pos[i]; ja < a2_pos[(i+1)]; ja++) {
      for (int32_t k = 0; k < DIMS; k++) {
        int32_t kC = i * DIMS + k;
        int32_t jD = k * DIMS + ja;
        y_vals[iy] += (a_vals[ja] * x->vals[kC]) * z->vals[jD];
        iy++;
      }
    }
  }
}

void top() {
    // incode
    taco_tensor_t* A = (taco_tensor_t*)((uint64_t) 0x80c00000);
    // A->indices = {0,5,9,14,17,21,25,30,34,40,45,49,55,60,63,68,73,78,83,88,91,99,102,108,116,121,126,130,134,137,142,147,152,156,162,166,171,177,181,189,192,196,199,202,207,211,216,222,228,232,240,243,248,252,258,266,270,274,278,283,291,299,305,308,312,320,328,332,336,340,348,351,355,358,363,368,373,379,383,388,396,400,403,411,419,427,431,436,440,444,449,455,460,468,472,478,482,485,491,499,503,511,515,519,525,529,537,540,545,549,553,556,564,572,580,584,588,596,599,602,605,613,617,625,633,637,640,648,651,659,662,668,672,676,684,692,697,705,713,717,725,733,737,741,744,751,760,768,776,779,783,787,792,800,804,809,813,817,823,831,837,845,853,861,865,873,878,883,891,896,904,910,915,919,923,931,935,938,942,950,958,966,974,979,984,989,997,1002,1005,1013,1021,1029,1037,1042,1046,1051,1056,1061,1064,1069,1073,1078,1083,1086,1091,1097,1102,1105,1110,1114,1122,1127,1135,1140,1145,1151,1159,1164,1172,1180,1188,1193,1201,1206,1211,1214,1222,1230,1234,1237,1242,1247,1251,1255,1263,1266,1271,1277,1282,1288,1296,1304,1312,1320,1328,1336,1340,1348,1351,1355,1360,1365,1368,1371,1376,1382,1390,1398,1406,1411,1417,1422,1427,1433,1438,1444,1449,1455,1460,1468,1476,1484,1488,1493,1497,1502,1507,1513,1516,1521,1529,1535,1543,1551,1556,1561,1569,1573,1577,1581,1586,1589,1594,1600,1608,1616,1619,1623,1629,1632,1635,1644,1647,1655,1663,1671,1679,1683,1691,1700,1707,1715,1723,1731,1735,1743,1747,1753,1758,1763,1769,1773,1777,1782,1788,1791,1795,1798,1803,1809,1813,1818,1824,1829,1835,1841,1846,1849,1857,1861,1865,1873,1881,1889,1897,1905,1913,1921,1927,1935,1943,1951,1955,1959,1967,1970,1973,1981,1984,1988,1996,2000,2003,2011,2019,2027,2035,2039,2047,2055,2063,2071,2079,2085,2093,2099,2105,2108,2111,2116,2124,2132,2140,2144,2148,2152,2160,2168,2171,2176,2184,2190,2194,2199,2202,2206,2212,2220,2225,2231,2237,2245,2253,2261,2269,2277,2285,2293,2296,2300,2303,2307,2311,2314,2317,2325,2328,2336,2342,2350,2355,2363,2366,2374,2382,2390,2398,2401,2405,2409,2413,2417,2421,2429,2433,2441,2450,2453,2462,2469,2474,2482,2490,2495,2503,2511,2519,2527,2530,2537,2545,2553,2557,2561,2565,2574,2582,2588,2596,2604,2612,2620,2628,2633,2641,2646,2654,2659,2667,2669,2671,2672,2673,2674,2675,2676,2677,2678,2679,2683,2686,2689,2692,2696,2699,2703,2706,2709,2712,2715,2720,2723,2726,2730,2735,2740,2743,2747,2750,2754,2761,2764,2772,2777,2780,2783,2786,2791,2798,2805,2808,2815,2818,2821,2824,2827,2834,2840,2847,2851,2854,2860,2864,2868,2871,2877,2880,2886,2889,2893,2898,2902,2905,2909,2914,2917,2920,2925,2928,2934,2937,2940,2944,2949,2954,2961,2968,2971,2978,2981,2984,2992,3002,3005,3008,3011,3017,3021,3027,3034,3037,3040,3044,3049,3057,3060,3066,3069,3072,3076,3081,3087,3094,3098,3103,3108,3111,3114,3122,3125,3129,3133,3136,3141,3149,3156,3159,3162,3165,3171,3179,3182,3188,3191,3194,3202,3209,3212,3215,3221,3224,3227,3230,3235,3238,3244,3247,3253,3259,3266,3271,3274,3277,3284,3287,3295,3299,3302,3305,3312,3316,3318,3322,3325,3327,3330,3337,3340,3345,3355,3360,3363,3368,3376,3380,3384,3393,3396,3399,3402,3405,3410,3413,3418,3421,3424,3430,3433,3436,3446,3449,3452,3455,3459,3464,3469,3472,3475,3480,3487,3490,3497,3500,3508,3517,3525,3531,3538,3542,3545,3548,3551,3554,3560,3566,3573,3578,3584,3587,3595,3601,3605,3611,3618,3622,3628,3631,3637,3641,3648,3654,3657,3665,3673,3681,3684,3691,3699,3704,3709,3717,3720,3724,3727,3730,3733,3740,3746,3752,3755,3761,3768,3774,3781,3788,3793,3803,3806,3809,3812,3817,3823,3826,3832,3835,3838,3841,3848,3854,3860,3863,3869,3871,3877,3884,3887,3893,3900,3907,3917,3920,3923,3926,3929,3935,3938,3942,3948,3954,3957,3960,3969,3975,3978,3985,3988,3991,3995,3998,4005,4008,4014,4019,4026,4029,4032,4038,4044,4049,4054,4060,4063,4065,4070,4075,4081,4088,4093,4096,4103,4110,4116,4121,4126,4134,4140,4145,4150,4153,4159,4166,4169,4175,4182,4186,4189,4196,4202,4205,4211,4217,4220,4225,4231,4234,4241,4247,4251,4257,4263,4266,4269,4273,4276,4283,4287,4293,4299,4306,4313,4319,4324,4330,4340,4345,4351,4362,4365,4371,4374,4376,4383,4387,4393,4396,4401,4406,4413,4419,4422,4428,4433,4438,4446,4452,4455,4461,4467,4472,4479,4488,4494,4504,4507,4513,4520,4527,4530,4536,4544,4551,4557,4562,4565,4571,4578,4582,4584,4589,4593,4597,4603,4607,4614,4620,4626,4634,4640,4643,4647,4651,4657,4662,4667,4674,4678,4682,4690,4693,4701,4705,4710,4715,4720,4723,4729,4735,4741,4747,4756,4759,4762,4769,4775,4781,4786,4789,4795,4805,4813,4818,4824,4827,4835,4838,4844,4852,4858,4862,4865,4872,4879,4885,4890,4896,4903,4906,4909,4915,4918,4924,4927,4933,4936,4939,4942,4949,4956,4959,4965,4968,4974,4980,4986,4991,4999,5002,5008,5011,5019,5027,5032,5037,5042,5048,5051,5054,5057,5064,5067,5073,5080,5083,5086,5092,5097,5101,5105,5112,5119,5123,5130,5134,5137,5143,5149,5156,5163,5170,5178,5185,5191,5198,5204,5208,5212,5215,5222,5227,5235,5242,5249,5255,5258,5263,5272,5274,5279,5282,5288,5296,5302,5307,5310,5318,5328,5334,5337,5345,5350,5353,5358,5361,5367,5374,5382,5387,5395,5408,5415,5422,5429,5436,5442,5445,5451,5456,5463,5468,5471,5477,5483,5489,5495,5501,5504,5510,5517,5520,5523,5526,5529,5535,5541,5544,5552,5557,5562,5570,5575,5581,5584,5587,5590,5599,5602,5605,5611,5615,5622,5627,5633,5638,5641,5647,5650,5656,5663,5666,5672,5675,5681,5687,5693,5699,5702,5708,5714,5721,5728,5735,5738,5741,5745,5752,5758,5765,5772,5775,5781,5786,5792,5799,5806,5813,5818,5823,5830,5838,5845,5851,5855,5859,5865,5872,5874,5881,5888,5893,5900,5903,5910,5916,5922,5925,5932,5939,5945,5951,5957,5960,5965,5972,5975,5982,5985,5991,5998,6004,6009,6014,6021,6029,6035,6041,6047,6053,6060,6064,6071,6078,6085,6091,6094,6099,6104,6109,6116,6123,6130,6132,6137,6142,6147,6153,6158,6164,6167,6180,6183,6189,6195,6202,6208,6214,6219,6226,6230,6233,6240,6243,6249,6254,6257,6262,6268,6272,6276,6283,6287,6294,6301,6308,6315,6324,6330,6333,6340,6347,6353,6356,6359,6366,6370,6377,6384,6388,6394,6396,6399,6402,6408,6411,6414,6417,6422,6429,6435,6443,6449,6455,6458,6465,6469,6473,6480,6487,6490,6494,6500,6506,6513,6521,6524,6527,6530,6535,6538,6545,6549,6554,6557,6563,6566,6573,6575,6578,6585,6591,6594,6600,6606,6614,6620,6626,6629,6635,6638,6641,6647,6650,6656,6659,6662,6669,6672,6675,6681,6684,6691,6698,6705,6711,6719,6727,6730,6735,6740,6745,6752,6755,6761,6764,6767,6773,6779,6785,6790,6799,6807,6812,6817,6824,6827,6834,6839,6845,6851,6856,6860,6866,6872,6878,6884,6892,6898,6903,6906,6913,6917,6920,6926,6929,6932,6937,6944,6947,6954,6957,6963,6966,6972,6978,6985,6989,6996,7002,7009,7016,7023,7029,7032,7039,7051,7055,7062,7066,7078,7084,7091,7095,7101,7107,7112,7120,7128,7131,7138,7142,7145,7152,7160,7168,7174,7181,7187,7194,7199,7205,7210,7215,7221,7226,7233,7236,7238,7245,7248,7256,7262,7269,7274,7279,7286,7292,7298,7302,7308,7313,7320,7327,7333,7338,7342,7346,7351,7363,7371,7376,7378,7380,7387,7393,7396,7403,7406,7412,7419,7422,7428,7431,7437,7443,7449,7455,7461,7469,7475,7488,7494,7501,7507,7514,7521,7533,7539,7541,7546,7552,7562,7574,7577,7584,7590,7597,7602,7607,7613,7618,7623,7629,7632,7636,7640,7646,7654,7657,7660,7669,7672,7677,7680,7686,7692,7698,7704,7711,7714,7720,7725,7728,7735,7740,7747,7753,7758,7766,7771,7776,7788,7796,7804,7809,7818,7821,7828,7835,7837,7843,7844,7847,7853,7859,7867,7870,7876,7882,7889,7896,7900,7906,7909,7916,7920,7923,7929,7935,7940,7946,7952,7958,7961,7967,7973,7982,7988,7994,8000,8003,8009,8015,8021,8026,8034,8039,8045,8050,8055,8061,8066,8070,8076,8086,8093,8100,8106,8112,8115,8122,8129,8135,8140,8145,8151,8154,8161,8166,8171,8179,8186,8194,8198,8201,8204,8206,8213,8220,8227,8233,8240,8246,8252,8256,8266,8274,8283,8286,8294,8299,8306,8313,8321,8326,8332,8337,8340,8345,8351,8356,8363,8369,8372,8378,8385,8391,8397,8403,8409,8415,8418,8421,8424,8430,8433,8439,8443,8450,8457,8460,8463,8470,8474,8477,8480,8483,8486,8492,8498,8506,8509,8515,8520,8527,8533,8540,8543,8550,8553,8559,8563,8566,8573,8579,8582,8588,8594,8600,8606,8610,8613,8620,8628,8636,8641,8649,8654,8659,8664,8670,8675,8678,8685,8692,8695,8698,8701,8704,8710,8716,8722,8730,8734,8737,8740,8747,8751,8759,8764,8769,8772,8780,8781,8786,8794,8799,8804,8807,8814,8818,8825,8831,8837,8842,8847,8852,8857,8865,8872,8875,8882,8889,8893,8903,8911,8916,8923,8930,8942,8948,8954,8960,8967,8970,8976,8984,8991,8997,9003,9010,9017,9020,9023,9029,9032,9039,9043,9050,9057,9064,9073,9076,9082,9089,9092,9101,9107,9110,9117,9119,9123,9128,9134,9137,9143,9152,9155,9161,9168,9171,9176,9182,9189,9195,9205,9209,9212,9218,9221,9228,9234,9240,9246,9249,9255,9258,9264,9272,9278,9284,9290,9298,9303,9306,9313,9320,9327,9335,9339,9343,9354,9362,9369,9373,9382,9385,9393,9398,9406,9411,9416,9422,9427,9436,9443,9446,9453,9488,9492,9499,9505,9511,9514,9521,9523,9528,9533,9538,9544,9548,9552,9557,9562,9570,9576,9579,9585,9588,9593,9599,9600,9607,9613,9618,9625,9631,9638,9644,9652,9657,9662,9670,9673,9676,9684,9690,9696,9699,9799,9805,9808,9814,9820,9823,9829,9836,9839,9845,9849,9853,9860,9867,9872,9880,9885,9891,9898,9903,9909,9914,9921,9928,9934,9935,11245};
    // taco_tensor_t* A = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));

   
    // for (int k = 0; k < DIMS; k++) {
    //   A->indices[k] = indptrs[1];
    // //   // A->indices[k+1] = indptrs[k+1];
    // }
  taco_tensor_t* Y = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  taco_tensor_t* X = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  taco_tensor_t* Z = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));

  taco_tensor_t* A_grad = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  taco_tensor_t* Y_grad = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  taco_tensor_t* X_grad = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  taco_tensor_t* Z_grad = (taco_tensor_t*)malloc(sizeof(taco_tensor_t));
  
  __enzyme_autodiff<void>(compute, Y, Y_grad, A, A_grad, X, X_grad, Z, Z_grad) ;
}